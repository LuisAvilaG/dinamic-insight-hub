# Documentaci贸n del M贸dulo de Sincronizaci贸n

Este documento describe la arquitectura modular del m贸dulo de sincronizaci贸n y su flujo de trabajo para "Agregar Nueva Sincronizaci贸n". El objetivo principal es importar datos de ClickUp (tareas o registros de tiempo) a una base de datos de Supabase para su an谩lisis.

---

## I. Estructura Modular del C贸digo (Refactorizaci贸n)

El componente original `AddSyncWizard.tsx` ha sido refactorizado para mejorar la mantenibilidad y escalabilidad, siguiendo un patr贸n de custom hooks para la l贸gica y componentes de presentaci贸n para la UI.

### Componentes Clave:

*   **`src/components/admin/AddSyncWizard.tsx`**:
    *   Este es ahora el componente principal (contenedor) del asistente.
    *   Su rol es minimalista: importa y utiliza el `useSyncWizard` hook para obtener el estado y las funciones de l贸gica.
    *   Renderiza condicionalmente los componentes de presentaci贸n (`Step0_SyncTypeSelection`, `Step1_Connection`, etc.) y los modales, pas谩ndoles las props necesarias desde el hook.

*   **`src/components/admin/syncwizard/useSyncWizard.ts` (Custom Hook)**:
    *   Centraliza **toda la l贸gica de negocio y gesti贸n de estado** del asistente de sincronizaci贸n.
    *   Contiene todos los `useState`, `useEffect` y las funciones manejadoras (`handle...`) que dictan el comportamiento del asistente (ej. manejo de tokens, carga de workspaces/espacios, mapeo de campos, navegaci贸n entre pasos).
    *   Exporta un objeto con todos los estados y funciones que los componentes de presentaci贸n necesitan para funcionar.

*   **`src/components/admin/syncwizard/utils.ts`**:
    *   Almacena funciones puras y constantes que son reutilizadas por el custom hook o los componentes de presentaci贸n (ej. `groupListsByName`, `MANDATORY_FIELDS`).

*   **Componentes de Presentaci贸n (UI) - Ejemplos:**
    *   **`src/components/admin/syncwizard/Step0_SyncTypeSelection.tsx` (NUEVO)**: Componente UI para el primer paso, donde el usuario elige el tipo de sincronizaci贸n (tareas o tiempos).
    *   **`src/components/admin/syncwizard/Step1_Connection.tsx`**: Componente UI para la conexi贸n a ClickUp y selecci贸n de alcance.
    *   **`src/components/admin/syncwizard/Step2_Configuration.tsx`**: Componente UI para la configuraci贸n detallada de los datos (mapeo de campos, selecci贸n de listas).
    *   **`src/components/admin/syncwizard/Step3_Schedule.tsx`**: Componente UI para la programaci贸n de la sincronizaci贸n y modo de actualizaci贸n.

*   **Modales Reutilizables - Ejemplos:**
    *   **`src/components/admin/syncwizard/ConfigureColumnsModal.tsx`**: Modal para configurar los campos de una plantilla o lista espec铆fica.
    *   **`src/components/admin/syncwizard/ManageTemplatesModal.tsx`**: Modal para una gesti贸n expandida de las plantillas detectadas.

*   **Componente de Selecci贸n de Horario:**
    *   **`src/components/admin/ScheduleSelector.tsx`**: Componente UI para seleccionar la frecuencia de la sincronizaci贸n. (Se encuentra fuera de la carpeta `syncwizard/` y se importa con una ruta relativa adecuada).

---

## II. Flujo de Trabajo Detallado: "Agregar Nueva Sincronizaci贸n"

El flujo ha sido extendido con un Paso 0 inicial para la selecci贸n del tipo de sincronizaci贸n.

### Paso 0: Seleccionar Tipo de Sincronizaci贸n (El "Prop贸sito" )

*   **Decisi贸n Inicial:** El usuario es presentado con dos opciones fundamentales:
    *   **Sincronizar Tareas:** Enfocado en la extracci贸n de datos de tareas de ClickUp, incluyendo sus campos y detalles. Este es el flujo principal y funcional actual.
    *   **Sincronizar Registros de Tiempo:** Una opci贸n futura para extraer datos de seguimiento de tiempo de ClickUp. (Actualmente implementado como un placeholder deshabilitado en la UI, pero el `sync_type` se almacena correctamente).

*   **Navegaci贸n:** Al seleccionar "Sincronizar Tareas" y presionar "Siguiente", el asistente avanza al Paso 1.

### Paso 1: Conexi贸n y Alcance (El "Plug" )

*   **Nombre de la Sincronizaci贸n:** El usuario proporciona un nombre descriptivo para esta configuraci贸n de sincronizaci贸n.
*   **Autenticaci贸n y Selecci贸n:**
    *   El usuario ingresa su ClickUp API Token. Este token se guarda de forma segura y se utiliza para todas las interacciones con la API de ClickUp.
    *   Se le pide al usuario que seleccione un Workspace y un Espacio (Space) de ClickUp desde donde se extraer谩n los datos.
*   **Modo de Sincronizaci贸n de Campos (Solo para `sync_type = 'tasks'`):**
    *   **Interruptor [ Sincronizaci贸n Completa de Campos ]:**
        *   **Activado (`isFullSync = true`):** El sistema analizar谩 y sincronizar谩 autom谩ticamente *todos* los campos disponibles en el espacio seleccionado. Si est谩 activado, el asistente **saltar谩 el Paso 2** (Configuraci贸n de Datos) y avanzar谩 directamente al Paso 3.
        *   **Desactivado (`isFullSync = false`, Modo Personalizado):** El usuario desea tener control granular sobre qu茅 campos y listas sincronizar. El asistente avanzar谩 al Paso 2.
*   **Navegaci贸n:** Bot贸n "Anterior" regresa al Paso 0. Bot贸n "Siguiente" avanza al Paso 2 (o Paso 3 si `isFullSync` est谩 activado).

### Paso 2: Configuraci贸n de Datos (El "Play" 锔)

*Este paso **solo** se muestra si el `sync_type` es `'tasks'` y "Sincronizaci贸n Completa de Campos" en el Paso 1 est谩 desactivada.*

*   **Modo de Configuraci贸n:**
    *   **Detecci贸n Autom谩tica de Plantillas (por defecto):** El sistema agrupa autom谩ticamente las listas de ClickUp por nombres similares (detectando "plantillas"). Esto facilita la configuraci贸n masiva de campos para grupos de listas homog茅neas. Permite mover listas entre grupos para refinar la clasificaci贸n.
    *   **Modo Manual (alternativo):** Permite al usuario configurar cada lista individualmente.
*   **Configuraci贸n de Columnas/Campos:** Para cada plantilla o lista seleccionada, el usuario puede elegir qu茅 campos de ClickUp (est谩ndar y personalizados) desea importar. Se muestran campos obligatorios que no pueden ser deseleccionados.
*   **Sincronizaci贸n de Registros de Tiempo (Solo para `sync_type = 'tasks'`):** Un interruptor permite al usuario decidir si, adem谩s de las tareas, tambi茅n desea sincronizar los registros de tiempo asociados a esas tareas.
*   **Navegaci贸n:** Bot贸n "Anterior" regresa al Paso 1. Bot贸n "Siguiente" avanza al Paso 3.

### Paso 3: Destino y Programaci贸n (La Ejecuci贸n )

**A. Consideraciones sobre la Base de Datos (Destino)**

El sistema se encarga de preparar la base de datos de Supabase en un esquema dedicado `clickup_data` de forma din谩mica cuando el usuario guarda la sincronizaci贸n.

*   **1. Captura de la Configuraci贸n:** El sistema persiste un objeto JSON en la tabla `clickup.sync_configs` con toda la configuraci贸n del usuario, incluyendo:
    *   El `sync_type` seleccionado (tareas o tiempos).
    *   El `clickup_workspace_id` y `clickup_space_id`.
    *   El mapeo de campos seleccionados (para `sync_type = 'tasks'`).
    *   La frecuencia de la sincronizaci贸n (`cron_schedule`).
    *   El modo de sincronizaci贸n (`incremental` o `full`).
    *   Para `sync_type = 'tasks'` y `isFullSync = true`, el sistema inspecciona todas las listas del Espacio, identifica todos los campos 煤nicos y los usa para construir una plantilla de tabla universal.

*   **2. Traductor de Tipos:** Una l贸gica interna (`CLICKUP_TO_POSTGRE_TYPE_MAP` en la Edge Function `setup-sync-tables`) convierte los tipos de datos de ClickUp a tipos de columna de PostgreSQL compatibles (ej., `text`, `string` -> `TEXT`; `number`, `money` -> `NUMERIC`; `date` -> `TIMESTAMPTZ`; `labels`, `users` -> `JSONB`).

*   **3. Generaci贸n de SQL (`CREATE` vs `ALTER`):**
    *   **Si la tabla de destino no existe:** Se genera y ejecuta un comando `CREATE TABLE` en el esquema `clickup_data`, utilizando el nombre de la sincronizaci贸n como base para el nombre de la tabla. Se a帽aden columnas de sistema como `clickup_task_id` (PRIMARY KEY para tareas) y `last_synced_at`. La estructura de la tabla variar谩 dr谩sticamente si `sync_type` es `'tasks'` o `'time_entries'`.
    *   **Si la tabla ya existe (al editar una sincronizaci贸n):** El sistema la inspecciona y genera comandos `ALTER TABLE ... ADD COLUMN` para los nuevos campos que el usuario haya agregado a la configuraci贸n. Los campos que el usuario elimine de la configuraci贸n *no* se eliminan de la tabla para evitar la p茅rdida de datos hist贸ricos, pero dejar谩n de recibir actualizaciones.

**B. Configuraci贸n de la Sincronizaci贸n (Programaci贸n con `pg_cron`)**

*   **Frecuencia:** El usuario selecciona la periodicidad de la importaci贸n de datos (ej., cada hora, diariamente, semanalmente) utilizando el `ScheduleSelector`. Esto se traduce en una expresi贸n `cron`.
*   **Modo de Sincronizaci贸n:**
    *   **Incremental (Recomendado):** En cada ejecuci贸n, solo se sincronizan y actualizan las tareas o registros de tiempo que son nuevos o que han sido modificados desde la 煤ltima importaci贸n exitosa. Esto optimiza el rendimiento.
    *   **Reemplazo Completo:** En cada ejecuci贸n, se borran *todos* los datos existentes en la tabla de destino y se vuelven a cargar desde cero. Esto asegura una copia fresca pero es menos eficiente.
*   **Invocaci贸n de Edge Function:** Al guardar la configuraci贸n, la Edge Function `setup-sync-tables` utiliza `pg_cron` para programar la ejecuci贸n peri贸dica de la Edge Function de importaci贸n correspondiente (`import-clickup-full-be` para tareas, o una futura funci贸n `import-clickup-time-entries` para registros de tiempo), pasando el ID de la configuraci贸n de sincronizaci贸n. Adicionalmente, se realiza una invocaci贸n inmediata para iniciar la primera importaci贸n.

---

## III. Flujo de Datos y Conexi贸n Backend (Supabase Edge Functions)

Las Edge Functions de Supabase juegan un rol crucial en el backend para manejar la creaci贸n de tablas y la importaci贸n de datos.

*   **`setup-sync-tables` (Edge Function):**
    *   Recibe el `payload` completo del frontend, incluyendo el `sync_type`.
    *   Usa el `sync_type` para determinar la estructura de la tabla a crear en el esquema `clickup_data` (columnas espec铆ficas para `tasks` o `time_entries`).
    *   Genera y ejecuta el SQL (`CREATE TABLE` o `ALTER TABLE`).
    *   Programa el `pg_cron` job para la funci贸n de importaci贸n relevante (ej. `import-clickup-full-be` o `import-clickup-time-entries`), asegurando que el `sync_id` y el `sync_type` se pasen a la funci贸n de importaci贸n.

*   **`import-clickup-full-be` (Edge Function - Para Tareas):**
    *   Se invoca por `pg_cron`.
    *   Lee la configuraci贸n espec铆fica de `sync_configs` usando el `sync_id` proporcionado.
    *   Realiza llamadas a la API de ClickUp para extraer las tareas y sus campos seg煤n la configuraci贸n.
    *   Procesa los datos y realiza operaciones `UPSERT` en la tabla `clickup_data.sync_[nombre_sincronizacion]` correspondiente.
    *   Actualiza el `last_run_at` y `last_run_status` en `clickup.sync_configs`.

*   **`import-clickup-time-entries` (Edge Function - Para Registros de Tiempo - Futuro):**
    *   (Se implementar谩 de manera similar a `import-clickup-full-be`, pero se centrar谩 en la extracci贸n y almacenamiento de los datos de tiempo de ClickUp).

Este esquema proporciona una base s贸lida para el desarrollo futuro, permitiendo a帽adir nuevas funcionalidades de sincronizaci贸n de manera controlada y modular.
